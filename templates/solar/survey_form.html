{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card glass-card border-0 mb-5">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <h2 class="fw-bold text-gradient mb-0"><i class="bi bi-ui-checks text-primary me-2"></i>New Site
                        Survey</h2>
                    <p class="text-muted">Enter site details for feasibility check.</p>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        {% if form.errors or bank_form.errors %}
                        <div class="alert alert-danger">
                            <h5>Please correct the errors below:</h5>
                            {% if form.errors %}
                            <ul>
                                {% for field, errors in form.errors.items %}
                                <li><strong>{{ field|title }}:</strong> {{ errors|join:", " }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if bank_form.errors %}
                            <h6 class="mt-2">Bank Details Errors:</h6>
                            <ul>
                                {% for field, errors in bank_form.errors.items %}
                                <li><strong>{{ field|title }}:</strong> {{ errors|join:", " }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            <small class="text-muted">Click Auto-Detect to capture coordinates.</small>
                        </div>
                        {% endif %}
                </div>
                <!-- Section 1: Customer Details -->
                <h5 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-person-fill me-2"></i>Customer
                    Details</h5>
                <div class="bg-light p-3 rounded mb-4 border">
                    <div class="row">
                        <div class="col-md-6">{{ form.customer_name|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.connection_type|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.sc_no|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.phase|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">{{ form.feasibility_kw|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.phone_number|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.email|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.aadhar_no|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.pan_card|as_crispy_field }}</div>
                    </div>

                </div>

                <!-- Section 2: Bank Details (Mandatory) -->
                <h5 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-bank me-2"></i>Bank Details
                </h5>
                <div class="bg-light p-3 rounded mb-4 border">
                    <div class="row">
                        <div class="col-md-6">{{ bank_form.parent_bank|as_crispy_field }}</div>
                        <div class="col-md-6">{{ bank_form.parent_bank_ac_no|as_crispy_field }}</div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">{{ bank_form.loan_applied_bank|as_crispy_field }}</div>
                        <div class="col-md-4">{{ bank_form.loan_applied_ifsc|as_crispy_field }}</div>
                        <div class="col-md-4">{{ bank_form.loan_applied_ac_no|as_crispy_field }}</div>
                    </div>
                </div>

                <!-- Section 3: Site Details -->
                <h5 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-geo-alt-fill me-2"></i>Site
                    Details</h5>
                <div class="bg-light p-3 rounded mb-4 border">
                    <div class="row">
                        <div class="col-md-6">{{ form.area|as_crispy_field }}</div>
                        <div class="col-md-6">
                            {{ form.gps_coordinates|as_crispy_field }}
                            <!-- Location Logic is unchanged -->
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="getLocation()">
                                <i class="bi bi-geo"></i> Auto-Detect
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">{{ form.roof_type|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.roof_photo|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.structure_type|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.structure_height|as_crispy_field }}</div>
                    </div>
                </div>

                <!-- Section 4: Pricing & Approvals -->
                <h5 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-currency-rupee me-2"></i>Pricing &
                    Approvals</h5>
                <div class="bg-light p-3 rounded mb-4 border">
                    <div class="row">
                        <div class="col-md-6">{{ form.agreed_amount|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.advance_paid|as_crispy_field }}</div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">{{ form.mefma_status|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.division|as_crispy_field }}</div>
                    </div>

                    <!-- MEFMA = Yes -> Show RP Fields -->
                    <div class="row mt-2" id="mefmaFields" style="display:none;">
                        <div class="col-md-6">{{ form.rp_name|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.rp_phone_number|as_crispy_field }}</div>
                    </div>

                    <!-- MEFMA = No -> Show Reference Field -->
                    <div class="row mt-2" id="referenceField" style="display:none;">
                        <div class="col-md-12">{{ form.reference_name|as_crispy_field }}</div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">{{ form.pms_registration_number|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.registration_status|as_crispy_field }}</div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">{{ form.fe_remarks|as_crispy_field }}</div>
                    </div>
                </div>


                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-premium btn-lg">
                        <i class="bi bi-save me-2"></i>Submit Survey
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-light btn-lg border">Cancel</a>
                </div>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function getLocation() {
        const btn = document.querySelector('button[onclick="getLocation()"]');
        const inputField = document.getElementById('id_gps_coordinates');

        if (navigator.geolocation) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Detecting...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude.toFixed(6);
                const long = position.coords.longitude.toFixed(6);

                if (inputField) {
                    inputField.value = lat + ", " + long;
                    btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Captured';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');

                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-geo"></i> Auto-Detect';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    }, 3000);
                }
            }, function (error) {
                alert("Location error: " + error.message);
                btn.innerHTML = '<i class="bi bi-geo"></i> Auto-Detect';
                btn.disabled = false;
            });
        }
    }

    // Real-time Validation Logic
    document.addEventListener('DOMContentLoaded', function () {

        // Helper to restrict input to numbers only
        function setNumericOnly(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function (e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
        }

        // Helper to restrict input to alphabets and spaces only
        function setAlphaOnly(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function (e) {
                    this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
                });
            }
        }

        // Helper to validate length and show error
        function validateLength(fieldId, exactLength, fieldName) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('blur', function () {
                    const val = this.value;
                    let errorMsg = "";

                    if (!val) {
                        errorMsg = `${fieldName} is required.`;
                    } else if (val.length !== exactLength) {
                        errorMsg = `${fieldName} must be exactly ${exactLength} digits.`;
                    }

                    toggleError(this, errorMsg);
                });
            }
        }

        // Helper to validate PAN format
        function validatePan(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function () {
                    this.value = this.value.toUpperCase(); // Auto-uppercase
                });
                field.addEventListener('blur', function () {
                    const val = this.value;
                    const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
                    let errorMsg = "";

                    if (val && !panRegex.test(val)) {
                        errorMsg = "Invalid PAN number format.";
                    }
                    toggleError(this, errorMsg);
                });
            }
        }

        // UI Error Toggler
        function toggleError(inputElement, msg) {
            // Check if error div exists
            let errorDiv = inputElement.parentNode.querySelector('.text-danger.validation-error');

            if (msg) {
                inputElement.classList.add('is-invalid');
                inputElement.classList.remove('is-valid');

                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'text-danger validation-error small mt-1';
                    inputElement.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = msg;
            } else {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
        }

        // Apply Restrictions & Validations
        setNumericOnly('id_sc_no');
        validateLength('id_sc_no', 16, 'SC Number');

        setNumericOnly('id_aadhar_no');
        validateLength('id_aadhar_no', 12, 'Aadhar Number');

        setNumericOnly('id_phone_number');
        validateLength('id_phone_number', 10, 'Aadhar Linked Phone Number');

        setNumericOnly('id_rp_phone_number');
        validateLength('id_rp_phone_number', 10, 'RP Phone Number');

        validatePan('id_pan_card');

        setNumericOnly('id_parent_bank_ac_no');
        setNumericOnly('id_loan_applied_ac_no');

        // Apply Alpha-Only Restrictions
        setAlphaOnly('id_customer_name');
        setAlphaOnly('id_rp_name');
        setAlphaOnly('id_parent_bank');
        setAlphaOnly('id_loan_applied_bank');

        // Toggle MEFMA fields (Existing Logic)
        const mefmaSelect = document.getElementById('id_mefma_status');
        const mefmaFields = document.getElementById('mefmaFields');
        const referenceField = document.getElementById('referenceField');

        function toggleMefma() {
            if (mefmaSelect && mefmaFields && referenceField) {
                const val = mefmaSelect.value;
                const isConfirmed = val === 'True' || val === 'true';

                if (isConfirmed) {
                    mefmaFields.style.display = 'flex';
                    referenceField.style.display = 'none';
                } else {
                    mefmaFields.style.display = 'none';
                    referenceField.style.display = 'flex';
                }
            }
        }

        if (mefmaSelect) {
            mefmaSelect.addEventListener('change', toggleMefma);
            toggleMefma(); // Initial state
        }
    });

    // Bank Details Fetcher
    function fetchBankDetails() {
        const phoneField = document.getElementById('id_phone_number');
        const statusSpan = document.getElementById('bankFetchStatus');
        const parentBankField = document.getElementById('id_parent_bank');
        const acNoField = document.getElementById('id_parent_bank_ac_no');

        if (!phoneField || !phoneField.value) {
            alert("Please enter a phone number first.");
            return;
        }

        const phone = phoneField.value;
        statusSpan.textContent = "Searching...";
        statusSpan.className = "ms-2 small text-info";

        fetch(`/api/get-bank-details/?phone=${phone}`)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    if (data.parent_bank) parentBankField.value = data.parent_bank;
                    if (data.parent_bank_ac_no) acNoField.value = data.parent_bank_ac_no;

                    statusSpan.textContent = "Details Found & Auto-filled!";
                    statusSpan.className = "ms-2 small text-success fw-bold";
                } else {
                    statusSpan.textContent = data.message || "No previous bank details found.";
                    statusSpan.className = "ms-2 small text-warning";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusSpan.textContent = "Error fetching details.";
                statusSpan.className = "ms-2 small text-danger";
            });
    }
</script>
{% endblock %}