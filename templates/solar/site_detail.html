{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark mb-0">Project Details: {{ customer.customer_name }}</h2>
        <div>
            {% if request.user.is_staff %}
            <a href="{% url 'update_survey' customer.id %}" class="btn btn-warning shadow-sm me-2">
                <i class="bi bi-pencil-square me-1"></i> Update Details
            </a>
            {% endif %}
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>

    <div class="row">
        {% if view_mode == 'installer_only' or view_mode != 'fe_only' and request.user.userprofile.role != 'Field Engineer' or view_mode != 'fe_only' and request.user.is_staff %}
            {% if customer.has_installation %}
            <div class="col-md-12 mb-4">
                <div class="card glass-card">
                    <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-dark"><i class="bi bi-tools me-2"></i>Installation Report</h5>
                        <span class="badge bg-soft-primary text-primary px-3 py-2 rounded-pill">
                            <i class="bi bi-person-fill me-1"></i> Installer: {{ customer.installation.updated_by.get_full_name|default:customer.installation.updated_by.username }}
                        </span>
                    </div>

                    <div class="card-body">
                        <h6 class="text-uppercase text-secondary small fw-bold mb-3">System Specifications</h6>
                        <div class="row mb-4">
                            <div class="col-6 col-md-3 mb-3">
                                <small class="text-muted d-block">Inverter</small>
                                <span class="fw-bold text-dark">{{ customer.installation.inverter_make }}
                                    <span class="badge bg-light text-dark border ms-1">{{ customer.installation.inverter_phase }}</span>
                                </span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <small class="text-muted d-block">App Status</small>
                                {% if customer.installation.app_installation_status %}
                                <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i> Installed</span>
                                {% else %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
                                {% endif %}
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <small class="text-muted d-block">Warranty</small>
                                {% if customer.installation.warranty_claimed %}
                                <span class="text-success fw-bold"><i class="bi bi-shield-check me-1"></i> Claimed</span>
                                {% else %}
                                <span class="text-muted"><i class="bi bi-shield-x me-1"></i> Not Claimed</span>
                                {% endif %}
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <small class="text-muted d-block">Installed On</small>
                                <span class="font-monospace text-dark">{{ customer.installation.timestamp|date:"M d, Y" }}</span>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25">

                        <h6 class="text-uppercase text-secondary small fw-bold mb-3 mt-4">Material Consumption</h6>
                        <div class="row mb-4">
                            <div class="col-6 col-md-3 mb-3">
                                <div class="p-3 bg-light rounded text-center border">
                                    <small class="text-muted d-block">AC Cable</small>
                                    <span class="fw-bold fs-5 text-dark">{{ customer.installation.ac_cable_used }}<span class="fs-6 text-muted">m</span></span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="p-3 bg-light rounded text-center border">
                                    <small class="text-muted d-block">DC Cable</small>
                                    <span class="fw-bold fs-5 text-dark">{{ customer.installation.dc_cable_used }}<span class="fs-6 text-muted">m</span></span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="p-3 bg-light rounded text-center border">
                                    <small class="text-muted d-block">LA Cable</small>
                                    <span class="fw-bold fs-5 text-dark">{{ customer.installation.la_cable_used }}<span class="fs-6 text-muted">m</span></span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <div class="p-3 bg-light rounded text-center border">
                                    <small class="text-muted d-block">Pipes</small>
                                    <span class="fw-bold fs-5 text-dark">{{ customer.installation.pipes_used }}<span class="fs-6 text-muted">m</span></span>
                                </div>
                            </div>
                        </div>
                        {% if customer.installation.leftover_materials %}
                        <div class="alert alert-secondary border-0 bg-gray-100 mb-4">
                            <small class="fw-bold text-dark"><i class="bi bi-box-seam me-2"></i>Leftover Materials:</small>
                            <p class="mb-0 mt-1 small">{{ customer.installation.leftover_materials }}</p>
                        </div>
                        {% endif %}

                        <hr class="text-muted opacity-25">

                        <h6 class="text-uppercase text-secondary small fw-bold mb-3 mt-4">Site Gallery</h6>
                        <div class="row g-3">
                            {% if customer.installation.inverter_serial_photo %}
                            <div class="col-6 col-md-3">
                                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                                    <div class="ratio ratio-4x3">
                                        <img src="{{ customer.installation.inverter_serial_photo.url }}" class="card-img-top object-fit-cover" alt="Inverter Serial">
                                    </div>
                                    <div class="card-body p-2 text-center bg-white">
                                        <small class="text-muted">Inverter Serial</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if customer.installation.inverter_acdb_photo %}
                            <div class="col-6 col-md-3">
                                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                                    <div class="ratio ratio-4x3">
                                        <img src="{{ customer.installation.inverter_acdb_photo.url }}" class="card-img-top object-fit-cover" alt="ACDB/DCDB">
                                    </div>
                                    <div class="card-body p-2 text-center bg-white">
                                        <small class="text-muted">ACDB/DCDB</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if customer.installation.panel_serial_photo %}
                            <div class="col-6 col-md-3">
                                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                                    <div class="ratio ratio-4x3">
                                        <img src="{{ customer.installation.panel_serial_photo.url }}" class="card-img-top object-fit-cover" alt="Panel Serial">
                                    </div>
                                    <div class="card-body p-2 text-center bg-white">
                                        <small class="text-muted">Panel Serial</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if customer.installation.site_photos_with_customer %}
                            <div class="col-6 col-md-3">
                                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                                    <div class="ratio ratio-4x3">
                                        <img src="{{ customer.installation.site_photos_with_customer.url }}" class="card-img-top object-fit-cover" alt="Site w/ Customer">
                                    </div>
                                    <div class="card-body p-2 text-center bg-white">
                                        <small class="text-muted">Completed Site</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        {% if customer.installation.installer_remarks %}
                        <div class="mt-4 p-3 bg-light rounded border-start border-4 border-info">
                            <small class="text-uppercase text-info fw-bold">Installer Remarks</small>
                            <p class="mb-0 mt-1 text-dark">{{ customer.installation.installer_remarks }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %} {% endif %} {% if view_mode != 'installer_only' %}
        <div class="col-md-6 mb-4">
            <div class="card glass-card h-100">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 text-primary"><i class="bi bi-person me-2"></i>Customer Information</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">SC Number:</span>
                            <span class="fw-bold">{{ customer.sc_no }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Phase:</span>
                            <span>{{ customer.phase }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Phone:</span>
                            <span>{{ customer.phone_number }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Email:</span>
                            <span>{{ customer.email }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Aadhar Linked Phone:</span>
                            <span>{{ customer.aadhar_linked_phone }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card glass-card h-100">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 text-success"><i class="bi bi-wallet2 me-2"></i>Financial & Identity</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Aadhar Number:</span>
                            <span class="font-monospace">{{ customer.masked_aadhar }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">PAN Card:</span>
                            <span class="font-monospace">{{ customer.masked_pan }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Bank Account:</span>
                            <span>{{ customer.bank_account_no|default:"-" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted">Agreed Amount:</span>
                            <span class="fw-bold text-success">â‚¹ {{ customer.agreed_amount }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="text-muted">Registration Status:</span>
                            {% if customer.registration_status %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-danger">No</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-12 mb-4">
            <div class="card glass-card">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0 text-info"><i class="bi bi-geo me-2"></i>Site Specifications</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 col-md-3 mb-3">
                            <small class="text-muted d-block">Feasibility</small>
                            <span class="fw-bold fs-5">{{ customer.feasibility_kw }} KW</span>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <small class="text-muted d-block">Roof Type</small>
                            <span class="fw-bold">{{ customer.roof_type }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <small class="text-muted d-block">Structure</small>
                            <span class="fw-bold">{{ customer.structure_type }} ({{ customer.structure_height }} ft)</span>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <small class="text-muted d-block">GPS Coordinates</small>
                            <span class="fw-bold d-block text-dark mt-1">{{ customer.gps_coordinates }}</span>
                            <div class="mt-2 ratio ratio-1x1 border rounded overflow-hidden shadow-sm">
                                <iframe
                                    src="https://maps.google.com/maps?q={{ customer.gps_coordinates }}&t=&z=15&ie=UTF8&iwloc=&output=embed"
                                    width="100%" height="100%" frameborder="0" style="border:0;"
                                    allowfullscreen></iframe>
                            </div>
                            <a href="https://maps.google.com/?q={{ customer.gps_coordinates }}" target="_blank"
                                class="btn btn-sm btn-outline-primary mt-2 w-100">
                                <i class="bi bi-box-arrow-up-right me-1"></i> Open Larger Map
                            </a>
                        </div>
                    </div>

                    {% if customer.roof_photo %}
                    <div class="mt-3">
                        <p class="mb-1 text-muted small">Roof Photo (Critical Site):</p>
                        <img src="{{ customer.roof_photo.url }}" class="img-fluid rounded shadow-sm"
                            style="max-height: 200px;">
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if customer.mefma_status %}
        <div class="col-md-12 mb-4">
            <div class="card border-warning bg-soft-warning">
                <div class="card-body">
                    <h5 class="text-warning-dark"><i class="bi bi-lightning-fill me-2"></i>MEFMA Approved</h5>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <span class="text-muted">RP Name:</span> <strong>{{ customer.rp_name }}</strong>
                        </div>
                        <div class="col-md-6">
                            <span class="text-muted">RP Phone:</span> <strong>{{ customer.rp_phone_number }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="col-md-12">
            <div class="card bg-light">
                <div class="card-body">
                    <small class="text-uppercase text-muted fw-bold">Field Engineer Remarks</small>
                    <p class="mb-0 mt-1">{{ customer.fe_remarks|default:"No remarks." }}</p>
                </div>
            </div>
        </div>
        {% endif %} </div>
</div>
{% endblock %}